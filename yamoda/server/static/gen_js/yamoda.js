// Generated by CoffeeScript 1.3.3

/*
# yamoda.coffee
# root module for YAMODA
#
# @author dpausp (Tobias Stenzel)
*/


/*-- private module vars --
*/


(function() {
  var add_module_constants, apply_module_constants, before_module_init, defined_modules, get_logger, is_module_defined, logg, make_module, module_constants, module_initializer, run_before_init, that, ym_logg,
    __hasProp = {}.hasOwnProperty;

  logg = ym_logg = void 0;

  that = this;

  module_initializer = {};

  module_constants = {};

  defined_modules = {};

  /*-- module functions --
  */


  get_logger = function(logger_name) {
    var logger;
    logg.debug("getting logger with name", logger_name);
    logger = log4javascript.getLogger(logger_name);
    ym_logg.addChild(logger);
    return logger;
  };

  is_module_defined = function(module_name) {
    if (module_name in defined_modules) {
      return true;
    } else {
      return false;
    }
  };

  add_module_constants = function(module_name, new_constants) {
    var constants, key, value;
    logg.debug("add constants for", module_name, new_constants);
    if (module_constants[module_name] === void 0) {
      constants = module_constants[module_name] = {};
    } else {
      constants = module_constants[module_name];
    }
    for (key in new_constants) {
      if (!__hasProp.call(new_constants, key)) continue;
      value = new_constants[key];
      constants[key] = value;
    }
    if (module_name in defined_modules) {
      yamoda.apply_module_constants(defined_modules[module_name]);
      return null;
    } else {
      return constants;
    }
  };

  before_module_init = function(module_name, func) {
    var handlers;
    if (module_initializer[module_name] === void 0) {
      handlers = module_initializer[module_name] = [];
    } else {
      handlers = module_initializer[module_name];
    }
    return handlers.push(func);
  };

  run_before_init = function(module_name) {
    var f, handlers, _i, _len;
    handlers = module_initializer[module_name] || [];
    for (_i = 0, _len = handlers.length; _i < _len; _i++) {
      f = handlers[_i];
      f();
    }
  };

  apply_module_constants = function(module) {
    var constants, key, value;
    constants = module_constants[module.MODULE_NAME] || {};
    if (constants) {
      logg.debug("applying constants for module", module.MODULE_NAME, constants);
      for (key in constants) {
        if (!__hasProp.call(constants, key)) continue;
        value = constants[key];
        module[key] = value;
      }
      module_constants[module.MODULE_NAME] = {};
    }
    return module;
  };

  make_module = function(module_name, attributes) {
    var already_defined_module, logger, module;
    already_defined_module = defined_modules[module_name];
    if (already_defined_module) {
      yamoda.logg.warn(module_name, "already defined, skipping!");
      return already_defined_module;
    } else {
      logger = get_logger(module_name);
      run_before_init(module_name);
      module = attributes;
      module.MODULE_NAME = module_name;
      module.logg = logger;
      apply_module_constants(module);
      defined_modules[module_name] = module;
      logger.info(module_name, "loaded");
      return module;
    }
  };

  /*-- READY --
  */


  $(function() {
    var console_appender, console_layout, root_logger, yamoda;
    if (that.yamoda) {
      console.log("yamoda already defined, skipping!");
      return;
    }
    root_logger = log4javascript.getRootLogger();
    ym_logg = log4javascript.getLogger("yamoda");
    console_layout = new log4javascript.PatternLayout("%r: %c| %m{1}%n");
    console_appender = new log4javascript.BrowserConsoleAppender();
    console_appender.setLayout(console_layout);
    root_logger.addChild(ym_logg);
    ym_logg.addAppender(console_appender);
    logg = ym_logg;
    logg.info("yamoda init");
    yamoda = that.yamoda = {
      logg: logg,
      get_logger: get_logger,
      is_module_defined: is_module_defined,
      add_module_constants: add_module_constants,
      apply_module_constants: apply_module_constants,
      before_module_init: before_module_init,
      run_before_init: run_before_init,
      make_module: make_module
    };
    $(document).ajaxError(function(event, jqxhr, settings, exception) {
      logg.warn("AJAX error occured, url", settings.url, "exception:", exception);
      console.log(event);
      console.log(jqxhr);
      console.log(settings);
      return alert("An internal server error occured. Sorry, please try again :-)\n" + "If the error persists, please contact admin@example.com.");
    });
    logg.info("yamoda root module loaded");
  });

}).call(this);
