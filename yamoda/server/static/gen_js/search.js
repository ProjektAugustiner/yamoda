// Generated by CoffeeScript 1.3.3

/*
# search.coffee
# search related stuff
#
# @author dpausp (Tobias Stenzel)
*/


/*-- private module vars --
*/


(function() {
  var MODULE_NAME, change_to_query_history, change_to_query_results, logg, query_results_shown, request_help_content, send_query_history_request, send_query_request, send_query_save_request;

  MODULE_NAME = "yamoda.search";

  logg = void 0;

  query_results_shown = false;

  /*-- module functions --
  */


  request_help_content = function(url) {
    $.get(url, function(helptext) {
      logg.info("got helptext for", url);
      $("#help-content").html(helptext);
    });
  };

  change_to_query_history = function() {
    logg.info("change_to_query_history");
    $("#query_results_content").hide();
    $("#query_history_content").show();
    $("#query_results_btn").show();
    $("#query_history_btn").hide();
    $("#action_dropdown").dropdown();
    $("#bottom-headline").text("Query History");
    query_results_shown = false;
  };

  change_to_query_results = function() {
    logg.info("change_to_query_results");
    $("#query_results_content").show();
    $("#query_history_content").hide();
    $("#query_history_btn").show();
    $("#query_results_btn").hide();
    query_results_shown = true;
    $("#bottom-headline").text("Query Results");
  };

  send_query_history_request = function() {
    $.get(yamoda.search.query_history_url, function(history_content) {
      logg.info("got history content");
      $("#query_history_content").html(history_content);
      return yamoda.queryhistory.setup_datatable();
    });
  };

  send_query_request = function(save_query) {
    var show_results;
    if (save_query == null) {
      save_query = true;
    }
    logg.info("send query request");
    show_results = $("input[name='show_results']:checked").val();
    logg.info("where to show results:", show_results);
    $("#bottom-headline").text("Processing...");
    return $.ajax({
      type: 'POST',
      url: yamoda.search.search_url,
      data: {
        query: $("#query_input").val(),
        name: $("#query_name_input").val(),
        save_query: save_query
      },
      success: function(query_result) {
        logg.info("received query request answer");
        $("#query_results_content").html(query_result);
        change_to_query_results();
        send_query_history_request();
      },
      error: function() {
        $("#bottom-headline").text("Server Error! Please try again.");
      }
    });
  };

  send_query_save_request = function() {
    logg.info("send query save request");
    $.ajax({
      type: 'POST',
      url: yamoda.search.save_query_url,
      data: {
        query: $("#query_input").val(),
        name: $("#query_name_input").val()
      },
      success: function(msg) {
        logg.info("received query save request answer");
        $("#main_msg_area").html(msg);
        return send_query_history_request();
      }
    });
  };

  /*-- READY --
  */


  $(function() {
    var that;
    that = yamoda.search = yamoda.make_module(MODULE_NAME, {
      request_help_content: request_help_content,
      change_to_query_history: change_to_query_history,
      change_to_query_results: change_to_query_results,
      send_query_request: send_query_request,
      send_query_save_request: send_query_save_request
    });
    logg = that.logg;
  });

}).call(this);
