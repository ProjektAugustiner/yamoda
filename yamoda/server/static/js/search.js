// Generated by CoffeeScript 1.3.3

/*
# search.coffee
# search related stuff
# 
# @author dpausp (Tobias Stenzel)
*/


/*-- private module vars --
*/


(function() {
  var YM_MODULE_NAME, change_to_query_history, change_to_query_results, logg, query_history_html, query_results_html, query_results_shown, send_query_history_request, send_query_request, send_query_save_request;

  YM_MODULE_NAME = "search";

  logg = void 0;

  query_results_shown = false;

  query_history_html = "";

  query_results_html = "";

  /*-- module functions --
  */


  change_to_query_history = function() {
    logg.info("change_to_query_history");
    $("#query_results_content").hide();
    $("#query_history_content").show();
    $("#query_results_btn").show();
    $("#query_history_btn").hide();
    $("#bottom-headline").text("Query History");
    yamoda.queryhistory.initialize_if_needed();
    query_results_shown = false;
  };

  change_to_query_results = function() {
    logg.info("change_to_query_results");
    $("#query_results_content").show();
    $("#query_history_content").hide();
    $("#query_history_btn").show();
    $("#query_results_btn").hide();
    query_results_shown = true;
    $("#bottom-headline").text("Query Results");
  };

  send_query_history_request = function() {
    $.get(yamoda.search.query_history_url, function(history_content) {
      logg.info("got history content");
      return $("#query_history_content").html(history_content);
    });
  };

  send_query_request = function() {
    var save_query, show_results;
    logg.info("send query request");
    show_results = $("input[name='show_results']:checked").val();
    logg.info("where to show results:", show_results);
    $("#bottom-headline").text("Processing...");
    save_query = $("#save_query_checkbox").attr("checked");
    return $.ajax({
      type: 'POST',
      url: yamoda.search.search_url,
      data: {
        query: $("#query_input").val(),
        name: $("#query_name_input").val(),
        save_query: save_query
      },
      success: function(query_result) {
        logg.info("received query request answer");
        $("#query_results_content").html(query_result);
        change_to_query_results();
        send_query_history_request();
      },
      error: function() {
        $("#bottom_headline").text("Error!");
      }
    });
  };

  send_query_save_request = function() {
    logg.info("send query save request");
    $.ajax({
      type: 'POST',
      url: yamoda.search.save_query_url,
      data: {
        query: $("#query_input").val(),
        name: $("#query_name_input").val()
      },
      success: function(msg) {
        logg.info("received query save request answer");
        $("#main_msg_area").html(msg);
        return send_query_history_request();
      }
    });
  };

  /*-- READY --
  */


  $(document).ready(function() {
    var module;
    if (yamoda[YM_MODULE_NAME]) {
      yamoda.logg.warn(YM_MODULE_NAME, "already defined, skipping!");
      return;
    }
    logg = yamoda.get_logger("yamoda.search");
    yamoda.run_before_init(YM_MODULE_NAME);
    $("#query_history_btn").hide();
    $("#query_results_btn").hide();
    module = yamoda.search = {
      YM_MODULE_NAME: YM_MODULE_NAME,
      request_help_content: function(url) {
        return $.get(url, function(helptext) {
          logg.info("got helptext for", url);
          return $("#help-content").html(helptext);
        });
      },
      change_to_query_history: change_to_query_history,
      change_to_query_results: change_to_query_results,
      send_query_request: send_query_request,
      send_query_save_request: send_query_save_request
    };
    yamoda.apply_module_constants(module);
    yamoda.logg.info("yamoda.search loaded");
  });

}).call(this);
