// Generated by CoffeeScript 1.3.3

/* 
# datadisplaytest.coffee
# test module for data displays
# 
# @author dpausp (Tobias Stenzel)
*/


/*-- private module vars --
*/


(function() {
  var YM_MODULE_NAME, logg, plot, plot_data, request_fakeentry_data;

  YM_MODULE_NAME = "datadisplaytest";

  logg = void 0;

  plot_data = [];

  plot = void 0;

  /*-- module functions --
  */


  request_fakeentry_data = function(yid) {
    return $.ajax({
      type: "GET",
      url: yamoda.base_url + "testentry/" + yid,
      dataType: "json",
      success: function(json) {
        var options, series;
        logg.info("got data for", yid, "plotting...");
        series = {
          data: json.data,
          label: "<strong>" + json.parameter_x + ":" + json.parameter_y + "</strong>",
          clickable: true,
          hoverable: true
        };
        plot_data.push(series);
        if (plot_data) {
          options = {
            series: {
              lines: {
                show: true
              },
              points: {
                show: true
              }
            },
            grid: {
              clickable: true,
              hoverable: true,
              autoHighlight: true
            }
          };
          plot = $.plot($("#plotdisplay"), plot_data, options);
        }
      }
    });
  };

  /*-- READY --
  */


  $(document).ready(function() {
    var module;
    if (yamoda[YM_MODULE_NAME]) {
      yamoda.logg.warn(YM_MODULE_NAME, "already defined, skipping!");
      return;
    }
    logg = yamoda.get_logger("yamoda.datadisplaytest");
    yamoda.run_before_init(YM_MODULE_NAME);
    $("#datatable").dataTable({
      bStateSave: false,
      aaSorting: [[6, "desc"], [3, "asc"], [1, "asc"]],
      aoColumns: [null, null, null, null, null, null, null]
    });
    $("td.valuecolumn").each(function(i, elem) {
      var cell_width, el$, pixel_per_value, value_count;
      el$ = $(elem);
      logg.info("sparkline for elem", i, el$.attr("normalMax"));
      value_count = el$.attr("count");
      cell_width = el$.width();
      pixel_per_value = cell_width / value_count;
      $(elem).sparkline("html", {
        type: "line",
        height: "60",
        tooltipFormat: '<span style="color: {{color}}">&#9679;</span> {{prefix}}{{x}} | {{y}}{{suffix}}',
        defaultPixelsPerValue: pixel_per_value,
        normalRangeMin: el$.attr("normalMin"),
        normalRangeMax: el$.attr("normalMax"),
        fillColor: false
      });
    });
    $("#plotdisplay").bind("plotclick", function(ev, pos, item) {
      if (item) {
        $("#plot_clicktext").html("Point #" + item.dataIndex + " in plot <strong>" + item.series.label + "</strong>");
      }
    });
    request_fakeentry_data(0);
    request_fakeentry_data(1);
    module = yamoda.datadisplaytest = {
      YM_MODULE_NAME: YM_MODULE_NAME
    };
    yamoda.apply_module_constants(module);
    logg.info("yamoda.datadisplaytest loaded");
  });

}).call(this);
