{% extends "layout.html" %}
{% set title = "Search" %}
{% block body %}
<script src="{{ url_for('static', filename='bootstrap-popover.js') }}"></script>
<script src="{{ url_for('static', filename='bootstrap-tooltip.js') }}"></script>
<div class="row-fluid">
  <div class="span5">
    <h2>Search for sets or datas</h2>
    <form action="{{ url_for('search') }}" method="post" class="form-vertical">
      <div class="control-group">
        <label class="control-label" for="query">Enter Query:</label>
        <div class="controls">
            <textarea name="query" id="query_input" rows="8"></textarea>
        </div>
        <label class="checkbox">Save query for later use
          <input type="checkbox" name="save_query"></input>
        </label>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-success">
          <i class="icon-ok-sign icon-white"></i>Submit</button>
        <button type="reset" class="btn btn-warning">
          <i class="icon-trash icon-white"></i>Reset</button>
      </div>
    </form>
  </div>
  <div class="span7">
    <h2>Query Language Help</h2>
    <ul class="nav nav-tabs">
    <li><a href="#" onclick="request_help_content('{{ url_for("get_helptext", name="find") }}')">Result Type</a>
    <li><a href="#" onclick="request_help_content('{{ url_for("get_helptext", name="param-filter") }}')">Parameter Filter</a>
    <li><a href="#" onclick="request_help_content('{{ url_for("get_helptext", name="sort") }}')">Sorting</a>
    <li><a href="#" onclick="request_help_content('{{ url_for("get_helptext", name="other") }}')">Other</a>
    <li><a href="#" onclick="request_help_content('{{ url_for("get_helptext", name="example-datas") }}')">Example Data Query</a>
    <li><a href="#" onclick="request_help_content('{{ url_for("get_helptext", name="example-sets") }}')">Set Query</a>
    </ul>
    <div id="help-content">
    <p>Select a help category above.</p>
    </div>
  </div>
</div>
<div class="row-fluid">
  <div class="span12">
    <h2>Query History</h2>
    <table id="querytable" class="table table-condensed table-bordered table-striped, table-hover">
      <thead>
        <tr>
          <th>#</th>
          <th>Created</th>
          <th>Name</th>
          <th>Insert Query</th>
          <th>Run</th>
          <th><input type="checkbox" onchange="toggleall(this)" /></th>
        </tr>
      </thead>
      <tbody>
        {%- for query in query_history %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ query.created|dtformat }}</td>
          <td>{{ query.name }}</td>
          <td>
            <a href="#" id="query_{{ loop.index0 }}"
              class="query_popover" onclick="insert_query('{{ loop.index0 }}')">{{- query.query_string -}}
            </a>
          </td>
          <td><a href="#" class="insert_query" onclick="run_query('{{ loop.index0 }}');">Run Query</a></td>
          <td><input type="checkbox" class="querycheck" id="check_{{ query.id }}" value="yes" /></td>
        </tr>
        {%- endfor %}
      </tbody>
    </table>
    <!-- adapted from datalist.html -->
    <div id="actionbutton" style="float: right">
      <div class="btn-group">
        <button class="btn dropdown-toggle btn-mini" data-toggle="dropdown" data-loading-text="Executing...">
          With selected
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <li><a href="#" onclick="delete_queries()">Delete</a></li>
        </ul>
      </div>
      <div class="alert alert-error hide" id="actionerror"></div>
    </div>
  </div>
</div>
<script type="text/javascript">
var query_links = $(".query_popover");
query_links.each(function(index, link) {
    var text = link.text.replace(/,/g, "<br>");
    $("#query_" + index).popover({content: text, title: "Click to insert #" + (index + 1),html: true, trigger: "hover"});
  })


var insert_query = function(row) {
  var newtext = $("#query_" + row).text().replace(/,/g, "\n");
  $("#query_input").val(newtext);
};

var run_query = function() {
  var query = $("#query_" + row).text();
  $.POST();
};

var toggleall = function(check) {
  if (check.checked)
    $('.querycheck').attr('checked', 'checked');
  else
    $('.querycheck').removeAttr('checked');
};

var request_help_content = function(url) {
  $.get(url, function(helptext) {
      $("#help-content").html(helptext);
    });
};

// adapted from datalist deletedatas()
var delete_queries = function() {
  var ids = $.map($('.querycheck:checked'), function(el) { return el.id.substr(6); });
  if (!ids) return;
  console.log(ids);
  $("#actionbutton button").button("loading");
  $.ajax({url: "{{ url_for('delete_queries') }}",
          type: "POST",
          data: {"ids": ids},
          success: function(data, st, xhr) { window.location.reload(); $('.querycheck').removeAttr('checked');},
          error: function(xhr, st, err) { $("#actionbutton button").button("reset");
                                          $("#actionerror").text(err).show(); }
          });
  return false;
};
//request_help_content('{{ url_for("get_helptext", name="param-filter") }}');


</script>
{% endblock %}

{# vim: set filetype=jinja sw=2 ts=2 sts=2 expandtab: #}
