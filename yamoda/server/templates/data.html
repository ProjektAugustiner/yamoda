{% extends "layout.html" %}
{% set title = "Data" %}
{% block extrahead %}
<!-- external libs -->
<script src="{{ url_for('static', filename='js/log4javascript.js') }}"></script>
<script src="{{ url_for('static', filename='jquery.sparkline.js') }}"></script>
<!-- yamoda base module -->
<script src="{{ url_for('static', filename='js/yamoda.js') }}"></script>
<script>
  $(document).ready(function () {
    yamoda.base_url = "{{ url_for('index') }}";
    yamoda.logg.info("base url is", yamoda.base_url);
  })
</script>
<!-- yamoda modules -->
<script src="{{ url_for('static', filename='js/entry.js') }}"></script>
{% endblock %}
{% block body %}
  <h2>Data: {{ data.name }}
  <small>Created {{ data.created|dtformat }}</small></h2>
  <h3>Entries:</h3>
  <hr>
  <table id="datatable" class="table table-condensed table-bordered table-striped">
    <thead>
      <tr>
        <th class="hidden"></th>
        <th>Parameter</th>
        <th>Value</th>
        <th>Unit</th>
        <th>Details</th>
        <th>Dim</th>
        <th>Size</th>
        <th>Visible?</th>
      </tr>
    </thead>
    <tbody>
      {%- for entry in data.entries %}
      <tr>
        <td class="hidden indexcolumn" index="{{ loop.index }}" entry_id="{{entry.id}}"></td>
        <td>
          {# Link to the Parameter description, parameter.brief is used as tooltip #}
          <a href="{{ url_for('context', context_name=entry.parameter.context.name)
                   }}#{{ entry.parameter.name }}"
             rel="tooltip" title="{{ entry.parameter.brief }}">
            {{ entry.parameter.name }}
          </a>
        </td>
        {% if not entry.value.shape %}
        <td>{{ entry.value|dataformat }}</td>
        {% elif entry.value.shape|length == 1 %}
        <td class="valuecolumn" 
          values="{{ entry.value|dataformat(600) }}" 
          count = "0"
          normalMin="0"
          normalMax="0">
          Loading...
        </td>
        {% elif entry.value.shape|length == 2 %}
        <td class="2d-preview">
          <a class="preview-image-link" imageUrl="{{url_for('entry', entry_id=entry.id)}}?img_url_for_type=png" href="#">
            Show image
          </a>
        </td>
        {% else %}
        <td>Multidimensional Value</td>
        {% endif %}
        <td>{{ entry.parameter.unit|unitformat }}</td>
        {% if entry.value.shape %}
        <td><a href="{{url_for('entry', entry_id=entry.id)}}">Show...</a></td>
        {% else %}
        <td>-</td>
        {% endif %}
        <td class="value-dimension">{{ entry.value|dimension }}D</td>
        {% if entry.value.shape %}
        <td>{{ entry.value|shape }}</td>
        {% else %}
        <td>-</td>
        {% endif %}
        <td>{{ entry.parameter.visible|yesnoformat }}</td>
      </tr>
      {%- endfor %}
    </tbody>
  </table>

<script>
{% coffee "main" %}
datatable_setup = () ->
  $("#datatable").dataTable(
    bStateSave: false
    aaSorting: [[7, "desc"], [5, "asc"], [1, "asc"]]
    #aoColumns: [
    #  null,
    #  null,
    #  null,
    #  null,
      #sType:
      #    "dimension"
   #   null,
    #  null,
    #  null
    #]
  )
  return



$( () ->
  #$("#datatable").dataTable()
  datatable_setup()
  yamoda.entry.sparkline_setup($("#datatable td.valuecolumn"))
  # 2D preview image setup
  $("#datatable td.2d-preview").each( (index) ->
    $that = $(this)
    $that.children("a").click(() ->

      display_preview_image = (json) ->
        $that.html('<img width="40%" src="' + json.img_url + '"></img>')
        return

      image_url = $that.children("a").attr("imageUrl")
      $.getJSON(image_url, display_preview_image)
    )
    return
  )
  $('a[rel=tooltip]').tooltip()
  return
)
{% endcoffee %}
</script>
{% endblock %}

{# vim: set filetype=htmljinja sw=2 ts=2 sts=2 expandtab: #}
