{% from "entry_macros.html" import entryvalue %}
{% from "plotting.html" import plotdisplay_includes, plotdisplay1D %}
{% extends "layout.html" %}
{% set title = "Data" %}
{% block extrahead %}
{{ plotdisplay_includes() }}
<!-- external libs -->
<script src="{{ url_for('static', filename='js/jquery.sparkline.js') }}"></script>
<!-- yamoda modules -->
<script src="{{ url_for('static', filename='gen_js/entry.js') }}"></script>
<script>
{% coffee "main" %}
$ ->
  yamoda.base_url = "{{ url_for('index') }}"
  yamoda.entry.sparkline_setup($("#entrytable td.valuecolumn .sparkline"))
  dtable = yamoda.utils.setup_datatable($("#entrytable"),
    resizable: false
    aaSorting: [[7, "desc"], [5, "asc"], [1, "asc"]]
  )
  yamoda.utils.setup_column_filter_boxes($("#entrytable th.footer input.filter-input"), dtable)
  # 2D preview image setup
  yamoda.entry.fetch_2D_preview_images($("#entrytable td.2d-preview"), "35%")
  yamoda.entry.flot_setup($("#plot"))
  $('a[rel=tooltip]').tooltip()

  selected_rows = []

  plot_current_selection = ->
    if _.size(selected_rows) == 2
      entry_x_url = $(selected_rows[0]).find(".url-column>a").attr("href")
      entry_y_url = $(selected_rows[1]).find(".url-column>a").attr("href")
      height = $(window).height() * 0.45
      yamoda.logg.info("new height of plot", height)
      $("#plot>.plot-area").height(height)
      yamoda.entry.get_two(entry_x_url, entry_y_url, (ex, ey) ->
        yamoda.entry.plot_1D_1D(ex, ey, $("#plot"))
        selected_rows = []
        $("#entrytable tr").removeClass("info").removeClass("row-selected")
      )
    return

  $("#plot_btn").click(plot_current_selection)

  $("#entrytable tr").click( ->
    $this = $(this)
    yamoda.logg.info("selection before:", selected_rows)
    url = $this.find(".url-column>a").attr("href")
    if $this.hasClass("row-selected")
      yamoda.logg.info("unselected", url)
      selected_rows = _.without(selected_rows, this)
    else
      yamoda.logg.info("selected", url)
      if _.size(selected_rows) == 2
        selected_rows = _.tail(selected_rows)
      selected_rows.push(this)
    $this.toggleClass("row-selected")
    $this.toggleClass("info")
    yamoda.logg.info("selection after:", selected_rows)
  )

  return
{% endcoffee %}
</script>
{% endblock %}
{% block body %}
<div class="row-fluid">
  <div class="span12">
    <h2>Plot</h2>
    <div class="span12" id="plot">
      {{ plotdisplay1D() }}
    </div>
  </div>
</div>
<div class="row-fluid">
  <div class="span12">
    <hr class="small-vertical-margin">
    <a id="plot_btn" class="btn btn-primary" href="#">Plot Selection</a>
    <hr class="small-vertical-margin">
    <h2>Data: {{ data.name }}
    <small>Created {{ data.created|dtformat }}</small></h2>
    <table id="entrytable" class="table table-condensed table-bordered table-striped">
      <thead>
        <tr>
          <th class="hidden"></th>
          <th class="header colresize" rel="tooltip" title="Click to sort, hold shift key to sort multiple columns">Parameter</th>
          <th class="header colresize" rel="tooltip" title="Click to sort, hold shift key to sort multiple columns">Value</th>
          <th class="header colresize" rel="tooltip" title="Click to sort, hold shift key to sort multiple columns">Unit</th>
          <th class="header colresize" rel="tooltip" title="Click to sort, hold shift key to sort multiple columns">Details</th>
          <th class="header colresize" rel="tooltip" title="Click to sort, hold shift key to sort multiple columns">Dim</th>
          <th class="header colresize" rel="tooltip" title="Click to sort, hold shift key to sort multiple columns">Size</th>
          <th class="header colresize" rel="tooltip" title="Click to sort, hold shift key to sort multiple columns">Visible?</th>
        </tr>
      </thead>
      <tbody>
        {%- for entry in data.entries %}
        <tr>
          <td class="hidden indexcolumn" index="{{ loop.index }}" entry_id="{{entry.id}}"></td>
          <td>
            {# Link to the Parameter description, parameter.brief is used as tooltip #}
            <a href="{{ url_for('context', context_name=entry.parameter.context.name)
                     }}#{{ entry.parameter.name }}"
               rel="tooltip" title="{{ entry.parameter.brief }}">
              {{ entry.parameter.name }}
            </a>
          </td>
          {{ entryvalue(entry, 500) }}
          <td>{{ entry.parameter.unit|unitformat }}</td>
          {% if entry.value.shape %}
          <td class="url-column"><a id="entry_url_{{loop.index0}}" href="{{url_for('entry', entry_id=entry.id)}}">Show...</a></td>
          {% else %}
          <td>-</td>
          {% endif %}
          <td class="value-dimension">{{ entry.value|dimension }}D</td>
          {% if entry.value.shape %}
          <td>{{ entry.value|shape }}</td>
          {% else %}
          <td>-</td>
          {% endif %}
          <td>{{ entry.parameter.visible|yesnoformat }}</td>
        </tr>
        {%- endfor %}
      </tbody>
        <tfoot>
          <th class="footer"><input type="text" name="filter_param" class="filter-input filter-init input-mini" value="Filter" data-column_num="1" /></th>
          <th></th>
          <th class="footer"><input type="text" name="filter_unit" class="filter-input filter-init input-mini" value="Filter" data-column_num="3" /></th>
          <th></th>
          <th class="footer"><input type="text" name="filter_dim" class="filter-input filter-init input-mini" value="Filter" data-column_num="5" /></th>
          <th class="footer"><input type="text" name="filter_size" class="filter-input filter-init input-mini" value="Filter" data-column_num="6" /></th>
          <th class="footer"><input type="text" name="filter_visible" class="filter-input filter-init input-mini" value="Visible?" data-column_num="7" /></th>
        </tfoot>
    </table>
    <a >
  </div>
<div>
{% endblock %}

{# vim: set filetype=htmljinja sw=2 ts=2 sts=2 expandtab: #}
